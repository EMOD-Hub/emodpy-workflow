# Modify Reports

- a. Explain how EMOD extracts data using a thing we call reports.
- b. Explain that reports can be configured to collect specific data and to keep file sizes down
- c. Add channels to the InsetChart
- d. Run EMOD
- e. Plot InsetChart and show new channels
- f. Add the EndRelationship report
- g. Run EMOD
- h. Plot relationship duration data

## What is a report?

Reports are output generated by EMOD. There are multiple built-in EMOD reports that are configured by Python code as
well as the ability to create custom reports for a project. [Documentation for both types of reports] is available. TODO link
The final result of all reports at EMOD runtime is the writing of output file(s) for analysis.

!!! Important
    The more data items and/or stratification levels a report is configured to capture the larger the files generated. 
    Keep reporting configurations as minimal as useful for a project to avoid massive files that are difficult to 
    process.

Reports are specified as Python code in a country model or a frame that builds from one. Reports that are frequently
used and/or infrequently modified for a given country model are often located in it. Project-specific reports or
custom configurations of common reports are typically located in the ``config.py`` file in a frame.

## Modify an existing report configuration

Here we demonstrate overriding the existing configuration of a report in a project frame that utilizes the Zambia 
country model.

The Zambia country model class exists in: ``emodpy_hiv/countries/zambia.py``. The following snippet from the Zambia
country model indicates its default specification of the **InsetChart** report:

```python
@classmethod
def build_reports(cls, reporters: Reporters) -> Reporters:
    reporters = super().build_reports(reporters=reporters)

    # ...

    reporters.add(InsetChart(reporters_object=reporters,
                             has_ip=None,  # default
                             has_interventions=None,      # default
                             include_pregnancies=False,   # default
                             include_coital_acts=True,    # default
                             event_channels_list=["NewInfectionEvent"]))

    # ...
```

If we wish to override this behavior in a project frame **without modifying the country model** we will need to override
it in our frame. Reports are specified as part of the EMOD config file, so we edit the frame file:``config.py``. This 
file typically contains (at minimum) the following function definition ready for us to use:

```python
def build_reports(reporters: Reporters):
    reporters = country_model.build_reports(reporters)
    return reporters
```

!!! Important
    Each report can only have at most ONE configuration. Duplicative configurations will generate an error.

We first remove the existing report that we do not want. Then we add a new definition of the report to replace it. E.g.
if we want to add information about pregnancies and potential mothers in the model, we copy/paste the **InsetChart**
definition from the Zambia country model and modify the appropriate parameter (**include_pregnancies=True**):

```python
def build_reports(reporters: Reporters):
    from emodpy_hiv.reporters.reporters import InsetChart, ReportRelationshipEnd

    reporters = country_model.build_reports(reporters)

    # Remove default built-in InsetChart configuration
    reporters.builtin_reporters = [reporter for reporter in reporters.builtin_reporters
                                   if not isinstance(reporter, InsetChart)]

    # Add new InsetChart configuration that records pregnancy information
    reporters.add(InsetChart(reporters_object=reporters,
                             has_ip=None,  # default
                             has_interventions=None,  # default
                             include_pregnancies=True,  # NOT the default
                             include_coital_acts=True,  # default
                             event_channels_list=["NewInfectionEvent"]))

    return reporters
```

Future executions of EMOD using this frame will now generate an ``InsetChart.json`` output file containing pregnancy
related data.

## Adding a new report configuration

Suppose we now want to add a project-specific report (**ReportRelationshipEnd**) that is not already included in the 
Zambia country model or our frame ``config.py``. We will need to add the report in the **build_reports** function in our
frame. Building on the prior example, we edit the frame ``config.py`` like so:

```python
def build_reports(reporters: Reporters):
    from emodpy_hiv.reporters.reporters import InsetChart, ReportRelationshipEnd

    reporters = country_model.build_reports(reporters)

    # Remove default built-in InsetChart configuration
    reporters.builtin_reporters = [reporter for reporter in reporters.builtin_reporters
                                   if not isinstance(reporter, InsetChart)]

    # Add new InsetChart configuration that records pregnancy information
    reporters.add(InsetChart(reporters_object=reporters,
                             has_ip=None,  # default
                             has_interventions=None,  # default
                             include_pregnancies=True,  # NOT the default
                             include_coital_acts=True,  # default
                             event_channels_list=["NewInfectionEvent"]))

    # Add ReportRelationshipEnd report
    reporters.add(ReportRelationshipEnd(reporters_object=reporters))

    return reporters
```

Future executions of EMOD using this frame will now generate an ``RelationshipEnd.csv`` output file containing
information regarding the end of modeled relationships.